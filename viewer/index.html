<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ðŸŒ¿ Forest Grid Map Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Patch for missing L.MultiPolygon (safe alias) -->
  <script>
    if (typeof L.MultiPolygon === "undefined") {
      L.MultiPolygon = function(latlngs, options) { return new L.Polygon(latlngs, options); };
    }
  </script>

  <!-- KML parser -->
  <script src="https://unpkg.com/leaflet-kml@latest/L.KML.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; background: #eef8f0; }
    #header {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.95); padding: 8px 14px; border-radius: 10px;
      font-family: Arial, sans-serif; font-weight: 700; color: #226622; z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: rgba(255,255,255,0.96); padding: 18px 30px; border-radius: 10px;
      font-family: Arial, sans-serif; font-size: 15px; color: #226622; z-index: 9998;
      box-shadow: 0 4px 14px rgba(0,0,0,0.15); transition: opacity .4s ease;
    }
    .grid-label { pointer-events: none; }
  </style>
</head>
<body>
  <div id="header">ðŸŒ¿ Forest Department â€” Grid Viewer</div>
  <div id="loading">ðŸ“‚ Fetching KML... please wait</div>
  <div id="map"></div>

  <script>
  // --------------- CONFIG ---------------
  const REPO = "krishnaSureshFor/tnforest_kml_to_grid_v2.0";
  const CDN_PREFIX = "https://cdn.jsdelivr.net/gh";
  // --------------------------------------

  // Initialize map & basemap
  const map = L.map("map").setView([11.3, 78.5], 10);
  const base = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { attribution: "&copy; Esri â€” Satellite Imagery", maxZoom: 19 }
  ).addTo(map);

  // Helper to hide loader (safe)
  function hideLoader() {
    const el = document.getElementById("loading");
    if (!el) return;
    el.style.opacity = "0";
    setTimeout(()=>el.style.display = "none", 450);
  }

  // Build KML URL using jsDelivr (CORS-safe)
  const params = new URLSearchParams(window.location.search);
  const fileId = params.get("id");
  if (!fileId) {
    alert("âŒ Missing KML ID in URL!");
    throw new Error("No ?id= parameter found");
  }
  const kmlUrl = `${CDN_PREFIX}/${REPO}@main/public_kml/${fileId}.kml`;
  console.log("ðŸ“‚ Fetching KML from:", kmlUrl);

  // Dynamically load measurement library (leaflet-measure-path) and its CSS.
  // We load it but do NOT block the KML loading on it.
  (function loadMeasureLib() {
    const css = document.createElement("link");
    css.rel = "stylesheet";
    css.href = "https://unpkg.com/leaflet-measure-path@2.2.0/leaflet-measure-path.css";
    document.head.appendChild(css);

    const script = document.createElement("script");
    script.src = "https://unpkg.com/leaflet-measure-path@2.2.0/leaflet-measure-path.min.js";
    script.onload = function() {
      try {
        if (typeof L.control.measurePath === "function") {
          // add the control when library is ready
          L.control.measurePath({
            showUnitControl: true,
            measureArea: true,
            measureDistance: true,
            position: "topleft",
            activeColor: "#2b9348",
            completedColor: "#ff6600"
          }).addTo(map);
          console.log("ðŸ“ Measure tool loaded");
        } else {
          console.warn("Measure lib loaded but expected function not found.");
        }
      } catch (e) {
        console.warn("Measure init error:", e);
      }
    };
    script.onerror = function() {
      console.warn("âš ï¸ Measurement library failed to load; continuing without measure tool.");
    };
    document.head.appendChild(script);
  })();

  // Load KML and display
  fetch(kmlUrl, { mode: "cors", cache: "no-cache" })
    .then(res => {
      console.log("Response status:", res.status);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.text();
    })
    .then(kmlText => {
      console.log("KML text length:", kmlText.length);

      // Strip ns prefixes (ns0:) so plugin parses consistently
      const cleanText = kmlText.replace(/<\/*\w+:/g, m => m.replace(/[\w:]+:/, ""));
      const parser = new DOMParser();
      const kml = parser.parseFromString(cleanText, "text/xml");
      const layer = new L.KML(kml);

      // separate groups (preserve KML styling)
      const gridGroup = L.layerGroup();
      const overlayGroup = L.layerGroup();

      // layer.eachLayer is available after L.KML parse; populate groups
      layer.eachLayer(function(l) {
        const name = (l.feature && l.feature.properties && (l.feature.properties.name || "")).toString().toLowerCase();
        if (name.includes("overlay") || name.includes("boundary")) overlayGroup.addLayer(l);
        else gridGroup.addLayer(l);
      });

      // add groups to map (default both on)
      gridGroup.addTo(map);
      overlayGroup.addTo(map);

      // add layer control (user toggles)
      L.control.layers(null, {
        "Grid Cells": gridGroup,
        "Overlay Boundary": overlayGroup
      }).addTo(map);

      // optional: add small labels for grid features (non-intrusive)
      gridGroup.eachLayer(function(l) {
        try {
          if (l.getBounds && l.feature && l.feature.properties && l.feature.properties.name) {
            const c = l.getBounds().getCenter();
            L.marker(c, {
              icon: L.divIcon({
                className: "grid-label",
                html: `<div style="background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:11px;">${l.feature.properties.name}</div>`,
                iconSize: null
              }),
              interactive: false
            }).addTo(map);
          }
        } catch(e) { /* ignore label errors */ }
      });

      // fit bounds if available, hide loader reliably
      setTimeout(() => {
        try {
          const bounds = layer.getBounds();
          if (bounds && bounds.isValid && bounds.isValid()) {
            map.fitBounds(bounds);
          }
        } catch (e) { console.warn("Could not fit bounds:", e); }
        hideLoader();
      }, 700);

    })
    .catch(err => {
      console.error("Failed to load KML:", err);
      hideLoader();
      alert("Could not load KML. Check console for details.");
    });

  </script>
</body>
</html>
